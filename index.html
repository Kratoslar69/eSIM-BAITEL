<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador eSIM BAITEL - Sincronizaci√≥n en la Nube</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .sync-status {
            position: absolute;
            top: 15px;
            right: 20px;
            padding: 8px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #27ae60;
            animation: pulse 2s infinite;
        }

        .sync-indicator.connecting {
            background: #f39c12;
        }

        .sync-indicator.error {
            background: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .search-filters {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto auto auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
        }

        .import-section {
            display: flex;
            gap: 15px;
            align-items: center;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 10px;
            border: 2px dashed #27ae60;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        .form-group input, .form-group select {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
            font-size: 12px;
            padding: 8px 16px;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
            font-size: 12px;
            padding: 8px 16px;
        }

        .btn-export {
            background: #8e44ad;
            color: white;
        }

        .btn-export:hover:not(:disabled) {
            background: #7d3c98;
            transform: translateY(-2px);
        }

        .btn-import {
            background: #27ae60;
            color: white;
        }

        .btn-import:hover:not(:disabled) {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn-sync {
            background: #17a2b8;
            color: white;
        }

        .btn-sync:hover:not(:disabled) {
            background: #138496;
            transform: translateY(-2px);
        }

        .file-input {
            display: none;
        }

        .file-label {
            padding: 12px 24px;
            background: #6c757d;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
        }

        .file-label:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .content {
            padding: 30px;
        }

        .view-toggle {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        .view-toggle button {
            padding: 10px 20px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .view-toggle button.active {
            background: #3498db;
            color: white;
        }

        .grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .esim-card {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px;
            background: white;
            transition: all 0.3s;
            position: relative;
        }

        .esim-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #3498db;
        }

        .esim-card.usado {
            border-color: #e74c3c;
            background: #ffeaa7;
        }

        .esim-card.disponible {
            border-color: #27ae60;
            background: #d5f4e6;
        }

        .status-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-badge.disponible {
            background: #27ae60;
            color: white;
        }

        .status-badge.usado {
            background: #e74c3c;
            color: white;
        }

        .qr-container {
            text-align: center;
            margin-bottom: 15px;
        }

        .qr-placeholder {
            width: 120px;
            height: 120px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .qr-placeholder:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }

        .esim-info {
            font-size: 14px;
        }

        .esim-info .field {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .esim-info .label {
            font-weight: 600;
            color: #495057;
        }

        .esim-info .value {
            color: #6c757d;
            font-family: monospace;
        }

        .assigned-to {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
        }

        .assigned-to input {
            width: 100%;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
        }

        .card-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .table-view {
            display: none;
            overflow-x: auto;
        }

        .table-view.active {
            display: block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .qr-mini {
            width: 40px;
            height: 40px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .modal-qr {
            width: 300px;
            height: 300px;
            margin: 20px auto;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 30px;
            cursor: pointer;
            color: #aaa;
        }

        .close:hover {
            color: #000;
        }

        .assignment-input {
            margin: 15px 0;
            text-align: left;
        }

        .assignment-input label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .assignment-input input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .search-filters {
                grid-template-columns: 1fr;
            }
            
            .grid-view {
                grid-template-columns: 1fr;
            }
            
            .stats {
                flex-direction: column;
                gap: 20px;
            }

            .import-section {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="sync-status">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncStatus">Conectando...</span>
            </div>
            <h1>Administrador eSIM BAITEL</h1>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalCount">0</div>
                    <div>Total eSIM</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="availableCount">0</div>
                    <div>Disponibles</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="usedCount">0</div>
                    <div>Usadas</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="search-filters">
                <div class="form-group">
                    <label>Buscar</label>
                    <input type="text" id="searchInput" placeholder="ICCID, MSISDN, IMSI, Asignado a...">
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="statusFilter">
                        <option value="">Todos</option>
                        <option value="Disponible">Disponible</option>
                        <option value="Usado">Usado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Producto</label>
                    <select id="productFilter">
                        <option value="">Todos</option>
                        <option value="MOV">MOV</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>IP</label>
                    <select id="ipFilter">
                        <option value="">Todos</option>
                        <option value="CB127">CB127</option>
                    </select>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="resetFilters()">Limpiar</button>
                </div>
                <div>
                    <button class="btn btn-export" onclick="exportToExcel()" id="exportBtn">Exportar Excel</button>
                </div>
                <div>
                    <button class="btn btn-sync" onclick="syncWithGitHub()" id="syncBtn">Sincronizar GitHub</button>
                </div>
            </div>

            <div class="import-section">
                <div style="flex: 1;">
                    <h4 style="margin-bottom: 10px; color: #27ae60;">üìÅ Importar Nuevo Inventario</h4>
                    <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                        Selecciona un archivo CSV con nuevas eSIM para agregar al inventario existente
                    </p>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="file" id="csvFileInput" class="file-input" accept=".csv" onchange="handleFileSelect(event)">
                    <label for="csvFileInput" class="file-label">Seleccionar CSV</label>
                    <button class="btn btn-import" onclick="importCSV()" id="importBtn" disabled>Importar eSIM</button>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="view-toggle">
                <button class="active" onclick="switchView('grid')">Vista Cuadr√≠cula</button>
                <button onclick="switchView('table')">Vista Tabla</button>
            </div>

            <div id="loadingMessage" class="loading">Cargando datos desde la nube...</div>

            <div id="gridView" class="grid-view" style="display: none;"></div>

            <div id="tableView" class="table-view">
                <table>
                    <thead>
                        <tr>
                            <th>QR</th>
                            <th>ICCID</th>
                            <th>MSISDN</th>
                            <th>IMSI</th>
                            <th>PIN</th>
                            <th>PUK</th>
                            <th>Estado</th>
                            <th>Asignado a</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="qrModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modalTitle">C√≥digo QR eSIM</h3>
            <div class="modal-qr" id="modalQR"></div>
            <div id="modalInfo"></div>
        </div>
    </div>

    <script>
        // Configuraci√≥n de Firebase - REEMPLAZA CON TUS CREDENCIALES
        const firebaseConfig = {
            apiKey: "AIzaSyDummy-Replace-With-Your-API-Key",
            authDomain: "esim-baitel-default-rtdb.firebaseapp.com",
            databaseURL: "https://esim-baitel-default-rtdb.firebaseio.com",
            projectId: "esim-baitel",
            storageBucket: "esim-baitel.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:dummy-replace-with-yours"
        };

        // Configuraci√≥n del sistema
        const CONFIG = {
            githubRepo: 'Kratoslar69/esim-qr-baitel',
            githubApiUrl: 'https://api.github.com/repos/Kratoslar69/esim-qr-baitel/contents',
            qrBaseUrl: 'https://kratoslar69.github.io/esim-qr-baitel/',
            localStorageKey: 'esim_baitel_backup',
            syncInterval: 10000 // 10 segundos
        };

        // Variables globales
        let esimDatabase = [];
        let filteredData = [];
        let selectedFile = null;
        let database = null;
        let isConnected = false;

        // Inicializar Firebase
        function initializeFirebase() {
            try {
                // Para demo, usaremos una base de datos simulada con JSONBin.io
                // En producci√≥n, reemplaza esto con Firebase real
                updateSyncStatus('Conectando a la nube...', 'connecting');
                
                // Simular conexi√≥n exitosa despu√©s de 2 segundos
                setTimeout(() => {
                    isConnected = true;
                    updateSyncStatus('Conectado a la nube', 'connected');
                    loadDataFromCloud();
                }, 2000);
                
            } catch (error) {
                console.error('Error inicializando Firebase:', error);
                updateSyncStatus('Error de conexi√≥n', 'error');
                loadDataFromLocal();
            }
        }

        // Sistema de base de datos en la nube simulada
        class CloudDatabase {
            constructor() {
                this.apiUrl = 'https://api.jsonbin.io/v3/b/66da1234567890abcdef1234'; // Reemplazar con tu bin ID
                this.apiKey = '$2a$10$dummy.api.key.replace.with.yours'; // Reemplazar con tu API key
            }

            async save(data) {
                try {
                    // Para demo, guardamos en localStorage
                    // En producci√≥n, esto ser√≠a una llamada a Firebase
                    localStorage.setItem('esim_cloud_data', JSON.stringify({
                        data: data,
                        timestamp: new Date().toISOString()
                    }));
                    
                    // Simular delay de red
                    await new Promise(resolve => setTimeout(resolve, 500));
                    return true;
                } catch (error) {
                    console.error('Error guardando en la nube:', error);
                    return false;
                }
            }

            async load() {
                try {
                    // Para demo, cargamos de localStorage
                    // En producci√≥n, esto ser√≠a una llamada a Firebase
                    const cloudData = localStorage.getItem('esim_cloud_data');
                    
                    if (cloudData) {
                        const parsed = JSON.parse(cloudData);
                        return parsed.data;
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Error cargando de la nube:', error);
                    return null;
                }
            }

            async update(iccid, updates) {
                try {
                    const data = await this.load();
                    if (data) {
                        const esimIndex = data.findIndex(item => item.iccid === iccid);
                        if (esimIndex !== -1) {
                            data[esimIndex] = {
                                ...data[esimIndex],
                                ...updates,
                                fechaUltimoCambio: new Date().toISOString()
                            };
                            
                            await this.save(data);
                            return true;
                        }
                    }
                    return false;
                } catch (error) {
                    console.error('Error actualizando en la nube:', error);
                    return false;
                }
            }
        }

        const cloudDB = new CloudDatabase();

        function updateSyncStatus(message, status = 'connected') {
            const statusElement = document.getElementById('syncStatus');
            const indicator = document.getElementById('syncIndicator');
            
            statusElement.textContent = message;
            
            indicator.className = 'sync-indicator';
            switch(status) {
                case 'connecting':
                    indicator.classList.add('connecting');
                    break;
                case 'error':
                    indicator.classList.add('error');
                    break;
                default:
                    // connected - mantiene el verde por defecto
                    break;
            }
        }

        async function loadDataFromCloud() {
            try {
                updateSyncStatus('Cargando datos...', 'connecting');
                
                const cloudData = await cloudDB.load();
                
                if (cloudData && cloudData.length > 0) {
                    esimDatabase = cloudData;
                    updateSyncStatus('Datos sincronizados', 'connected');
                } else {
                    // Primera vez - cargar datos iniciales
                    loadInitialData();
                    await cloudDB.save(esimDatabase);
                    updateSyncStatus('Datos inicializados', 'connected');
                }
                
                filteredData = [...esimDatabase];
                hideLoading();
                updateStats();
                renderGrid();
                renderTable();
                
            } catch (error) {
                console.error('Error cargando datos de la nube:', error);
                updateSyncStatus('Error de sincronizaci√≥n', 'error');
                loadDataFromLocal();
            }
        }

        function loadDataFromLocal() {
            try {
                const localData = localStorage.getItem(CONFIG.localStorageKey);
                if (localData) {
                    esimDatabase = JSON.parse(localData);
                } else {
                    loadInitialData();
                }
                
                filteredData = [...esimDatabase];
                hideLoading();
                updateStats();
                renderGrid();
                renderTable();
                updateSyncStatus('Solo local (sin conexi√≥n)', 'error');
            } catch (error) {
                console.error('Error cargando datos locales:', error);
                loadInitialData();
                hideLoading();
                updateStats();
                renderGrid();
                renderTable();
            }
        }

        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('gridView').style.display = 'grid';
        }

        function loadInitialData() {
            const csvData = `ICCID ,Asignada a ,OI,BE_ID,IMSI,IMSI_rb1,IMSI_rb2,MSISDN,PIN 1,PUNK 1,SERIE VALID,IP,PRODUCTO 
8952140063883310669F,BT243,100,142,334140224894201,334140224894201,334140224894201,2219519816,1234,50862899,9271,CB127,MOV
8952140063883310677F,BT535,100,142,334140224894202,334140224894202,334140224894202,2219519832,1234,58399116,9271,CB127,MOV
8952140063883310685F,BT287,100,142,334140224894203,334140224894203,334140224894203,2219519836,1234,19360807,9271,CB127,MOV
8952140063883310693F,,100,142,334140224894204,334140224894204,334140224894204,2219519851,1234,55075610,9271,CB127,MOV
8952140063883310701F,,100,142,334140224894205,334140224894205,334140224894205,2219519852,1234,46271999,9271,CB127,MOV
8952140063883310719F,,100,142,334140224894206,334140224894206,334140224894206,2219519859,1234,81260431,9271,CB127,MOV
8952140063883310727F,,100,142,334140224894207,334140224894207,334140224894207,2219519867,1234,6471876,9271,CB127,MOV
8952140063883310735F,,100,142,334140224894208,334140224894208,334140224894208,2219519870,1234,58920758,9271,CB127,MOV
8952140063883310743F,,100,142,334140224894209,334140224894209,334140224894209,2219519871,1234,84721789,9271,CB127,MOV
8952140063883310750F,,100,142,334140224894210,334140224894210,334140224894210,2219519876,1234,4717880,9271,CB127,MOV
8952140063883310768F,,100,142,334140224894211,334140224894211,334140224894211,2219519878,1234,82185896,9271,CB127,MOV
8952140063883310776F,,100,142,334140224894212,334140224894212,334140224894212,2219519884,1234,65864765,9271,CB127,MOV
8952140063883310784F,,100,142,334140224894213,334140224894213,334140224894213,2219519908,1234,50321214,9271,CB127,MOV
8952140063883310792F,,100,142,334140224894214,334140224894214,334140224894214,2219519911,1234,87195908,9271,CB127,MOV
8952140063883310800F,,100,142,334140224894215,334140224894215,334140224894215,2219519933,1234,22547600,9271,CB127,MOV
8952140063883310818F,,100,142,334140224894216,334140224894216,334140224894216,2219519944,1234,79139902,9271,CB127,MOV
8952140063883310826F,,100,142,334140224894217,334140224894217,334140224894217,2219519957,1234,94072690,9271,CB127,MOV
8952140063883310834F,,100,142,334140224894218,334140224894218,334140224894218,2219519962,1234,71511049,9271,CB127,MOV
8952140063883310842F,,100,142,334140224894219,334140224894219,334140224894219,2219519986,1234,99984726,9271,CB127,MOV
8952140063883310859F,,100,142,334140224894220,334140224894220,334140224894220,2219520002,1234,36073770,9271,CB127,MOV
8952140063883310867F,,100,142,334140224894221,334140224894221,334140224894221,2219520006,1234,95076641,9271,CB127,MOV
8952140063883310875F,,100,142,334140224894222,334140224894222,334140224894222,2219520007,1234,45633726,9271,CB127,MOV
8952140063883310883F,,100,142,334140224894223,334140224894223,334140224894223,2219520008,1234,46880602,9271,CB127,MOV
8952140063883310891F,,100,142,334140224894224,334140224894224,334140224894224,2219520009,1234,83924608,9271,CB127,MOV
8952140063883310909F,,100,142,334140224894225,334140224894225,334140224894225,2219520010,1234,78201394,9271,CB127,MOV
8952140063883310917F,,100,142,334140224894226,334140224894226,334140224894226,2219520011,1234,59170467,9271,CB127,MOV
8952140063883310925F,,100,142,334140224894227,334140224894227,334140224894227,2219520012,1234,85726130,9271,CB127,MOV
8952140063883310933F,,100,142,334140224894228,334140224894228,334140224894228,2219520013,1234,19843502,9271,CB127,MOV
8952140063883310941F,,100,142,334140224894229,334140224894229,334140224894229,2219520014,1234,36970845,9271,CB127,MOV
8952140063883310958F,,100,142,334140224894230,334140224894230,334140224894230,2219520015,1234,47208163,9271,CB127,MOV
8952140063883310966F,,100,142,334140224894231,334140224894231,334140224894231,2219520016,1234,82547091,9271,CB127,MOV
8952140063883310974F,,100,142,334140224894232,334140224894232,334140224894232,2219520017,1234,63516164,9271,CB127,MOV
8952140063883310982F,,100,142,334140224894233,334140224894233,334140224894233,2219520018,1234,89862627,9271,CB127,MOV
8952140063883310990F,,100,142,334140224894234,334140224894234,334140224894234,2219520019,1234,26316699,9271,CB127,MOV
8952140063883311006F,,100,142,334140224894235,334140224894235,334140224894235,2219520020,1234,43213832,9271,CB127,MOV
8952140063883311014F,,100,142,334140224894236,334140224894236,334140224894236,2219520021,1234,80559295,9271,CB127,MOV
8952140063883311022F,,100,142,334140224894237,334140224894237,334140224894237,2219520022,1234,61528368,9271,CB127,MOV
8952140063883311030F,,100,142,334140224894238,334140224894238,334140224894238,2219520023,1234,87874831,9271,CB127,MOV
8952140063883311048F,,100,142,334140224894239,334140224894239,334140224894239,2219520024,1234,24328903,9271,CB127,MOV
8952140063883311055F,,100,142,334140224894240,334140224894240,334140224894240,2219520025,1234,41226036,9271,CB127,MOV
8952140063883311063F,,100,142,334140224894241,334140224894241,334140224894241,2219520026,1234,78571499,9271,CB127,MOV
8952140063883311071F,,100,142,334140224894242,334140224894242,334140224894242,2219520027,1234,59540572,9271,CB127,MOV
8952140063883311089F,,100,142,334140224894243,334140224894243,334140224894243,2219520028,1234,85887035,9271,CB127,MOV
8952140063883311097F,,100,142,334140224894244,334140224894244,334140224894244,2219520029,1234,22341107,9271,CB127,MOV
8952140063883311105F,,100,142,334140224894245,334140224894245,334140224894245,2219520030,1234,39238240,9271,CB127,MOV
8952140063883311113F,,100,142,334140224894246,334140224894246,334140224894246,2219520365,1234,89582058,9271,CB127,MOV
8952140063883311121F,,100,142,334140224894247,334140224894247,334140224894247,2219520371,1234,90331032,9271,CB127,MOV
8952140063883311139F,,100,142,334140224894248,334140224894248,334140224894248,2219520382,1234,35455237,9271,CB127,MOV
8952140063883311147F,,100,142,334140224894249,334140224894249,334140224894249,2219520416,1234,99573266,9271,CB127,MOV
8952140063883311154F,,100,142,334140224894250,334140224894250,334140224894250,2219520435,1234,19860865,9271,CB127,MOV
8952140063883311162F,,100,142,334140224894251,334140224894251,334140224894251,2219520437,1234,22621418,9271,CB127,MOV
8952140063883311170F,,100,142,334140224894252,334140224894252,334140224894252,2219520439,1234,73540241,9271,CB127,MOV
8952140063883311188F,,100,142,334140224894253,334140224894253,334140224894253,2219520451,1234,91201692,9271,CB127,MOV
8952140063883311196F,,100,142,334140224894254,334140224894254,334140224894254,2219520469,1234,37153335,9271,CB127,MOV
8952140063883311204F,,100,142,334140224894255,334140224894255,334140224894255,2219520509,1234,32140093,9271,CB127,MOV
8952140063883311212F,,100,142,334140224894256,334140224894256,334140224894256,2219520519,1234,87650341,9271,CB127,MOV
8952140063883311220F,,100,142,334140224894257,334140224894257,334140224894257,2219520522,1234,59898871,9271,CB127,MOV
8952140063883311238F,,100,142,334140224894258,334140224894258,334140224894258,2219520557,1234,6993304,9271,CB127,MOV
8952140063883311246F,,100,142,334140224894259,334140224894259,334140224894259,2219520564,1234,35825752,9271,CB127,MOV
8952140063883311253F,,100,142,334140224894260,334140224894260,334140224894260,2219520565,1234,1169657,9271,CB127,MOV
8952140063883311261F,,100,142,334140224894261,334140224894261,334140224894261,2219520572,1234,98504122,9271,CB127,MOV
8952140063883311279F,,100,142,334140224894262,334140224894262,334140224894262,2219520594,1234,55708402,9271,CB127,MOV
8952140063883311287F,,100,142,334140224894263,334140224894263,334140224894263,2219520597,1234,47166163,9271,CB127,MOV
8952140063883311295F,,100,142,334140224894264,334140224894264,334140224894264,2219520599,1234,8902845,9271,CB127,MOV
8952140063883311303F,,100,142,334140224894265,334140224894265,334140224894265,2219520638,1234,94629049,9271,CB127,MOV
8952140063883311311F,,100,142,334140224894266,334140224894266,334140224894266,2219520684,1234,72255391,9271,CB127,MOV
8952140063883311329F,,100,142,334140224894267,334140224894267,334140224894267,2219520690,1234,37114426,9271,CB127,MOV
8952140063883311337F,,100,142,334140224894268,334140224894268,334140224894268,2219520728,1234,76122415,9271,CB127,MOV
8952140063883311345F,,100,142,334140224894269,334140224894269,334140224894269,2219520737,1234,42316606,9271,CB127,MOV
8952140063883311352F,,100,142,334140224894270,334140224894270,334140224894270,2219520752,1234,70775857,9271,CB127,MOV
8952140063883311360F,,100,142,334140224894271,334140224894271,334140224894271,2219520763,1234,54107104,9271,CB127,MOV
8952140063883311378F,,100,142,334140224894272,334140224894272,334140224894272,2219520798,1234,80015657,9271,CB127,MOV
8952140063883311386F,,100,142,334140224894273,334140224894273,334140224894273,2219520800,1234,73560348,9271,CB127,MOV
8952140063883311394F,,100,142,334140224894274,334140224894274,334140224894274,2219520845,1234,57488327,9271,CB127,MOV
8952140063883311402F,,100,142,334140224894275,334140224894275,334140224894275,2219520870,1234,6527175,9271,CB127,MOV
8952140063883311410F,,100,142,334140224894276,334140224894276,334140224894276,2219520873,1234,59618240,9271,CB127,MOV
8952140063883311428F,,100,142,334140224894277,334140224894277,334140224894277,2219520891,1234,91951503,9271,CB127,MOV
8952140063883311436F,,100,142,334140224894278,334140224894278,334140224894278,2219520898,1234,16743736,9271,CB127,MOV
8952140063883311444F,,100,142,334140224894279,334140224894279,334140224894279,2219520900,1234,62698561,9271,CB127,MOV
8952140063883311451F,,100,142,334140224894280,334140224894280,334140224894280,2219520906,1234,72301772,9271,CB127,MOV
8952140063883311469F,,100,142,334140224894281,334140224894281,334140224894281,2219520912,1234,68094126,9271,CB127,MOV
8952140063883311477F,,100,142,334140224894282,334140224894282,334140224894282,2219520914,1234,31971854,9271,CB127,MOV
8952140063883311485F,,100,142,334140224894283,334140224894283,334140224894283,2219520927,1234,84258841,9271,CB127,MOV
8952140063883311493F,,100,142,334140224894284,334140224894284,334140224894284,2219520933,1234,15006150,9271,CB127,MOV
8952140063883311501F,,100,142,334140224894285,334140224894285,334140224894285,2219520935,1234,71327303,9271,CB127,MOV
8952140063883311519F,,100,142,334140224894286,334140224894286,334140224894286,2219520962,1234,29198564,9271,CB127,MOV
8952140063883311527F,,100,142,334140224894287,334140224894287,334140224894287,2219520966,1234,11477757,9271,CB127,MOV
8952140063883311535F,,100,142,334140224894288,334140224894288,334140224894288,2219520973,1234,68595607,9271,CB127,MOV
8952140063883311543F,,100,142,334140224894289,334140224894289,334140224894289,2219520979,1234,39282907,9271,CB127,MOV
8952140063883311550F,,100,142,334140224894290,334140224894290,334140224894290,2219520983,1234,17997225,9271,CB127,MOV
8952140063883311568F,,100,142,334140224894291,334140224894291,334140224894291,2219520998,1234,19368964,9271,CB127,MOV
8952140063883311576F,,100,142,334140224894292,334140224894292,334140224894292,2219521003,1234,20099493,9271,CB127,MOV
8952140063883311584F,,100,142,334140224894293,334140224894293,334140224894293,2219521029,1234,87438603,9271,CB127,MOV
8952140063883311592F,,100,142,334140224894294,334140224894294,334140224894294,2219521032,1234,70003114,9271,CB127,MOV
8952140063883311600F,,100,142,334140224894295,334140224894295,334140224894295,2219521063,1234,26775040,9271,CB127,MOV
8952140063883311618F,,100,142,334140224894296,334140224894296,334140224894296,2219521064,1234,32884021,9271,CB127,MOV
8952140063883311626F,,100,142,334140224894297,334140224894297,334140224894297,2219521076,1234,86071161,9271,CB127,MOV
8952140063883311634F,,100,142,334140224894298,334140224894298,334140224894298,2219521088,1234,88106119,9271,CB127,MOV
8952140063883311642F,,100,142,334140224894299,334140224894299,334140224894299,2219521094,1234,47498142,9271,CB127,MOV
8952140063883311659F,,100,142,334140224894300,334140224894300,334140224894300,2219521106,1234,59294401,9271,CB127,MOV`;

            parseCSVData(csvData);
        }

        function parseCSVData(csvData) {
            const lines = csvData.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            const newEsims = [];
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length >= 13) {
                    const iccid = values[0].trim();
                    
                    // Verificar si ya existe
                    const exists = esimDatabase.find(esim => esim.iccid === iccid);
                    if (!exists) {
                        newEsims.push({
                            id: esimDatabase.length + newEsims.length + 1,
                            iccid: iccid,
                            asignadoA: values[1].trim(),
                            distribuidor: "BAITEL",
                            msisdn: values[7].trim(),
                            imsi: values[4].trim(),
                            pin: values[8].trim(),
                            puk: values[9].trim(),
                            serie: values[10].trim(),
                            ip: values[11].trim(),
                            producto: values[12].trim(),
                            estado: "Disponible",
                            fechaCreacion: new Date().toISOString().split('T')[0],
                            imageIndex: esimDatabase.length + newEsims.length + 1,
                            fechaUltimoCambio: new Date().toISOString()
                        });
                    }
                }
            }
            
            esimDatabase.push(...newEsims);
            return newEsims.length;
        }

        // Inicializaci√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initializeFirebase();
            setupEventListeners();
            
            // Sincronizaci√≥n autom√°tica cada 10 segundos
            setInterval(async () => {
                if (isConnected) {
                    try {
                        const cloudData = await cloudDB.load();
                        if (cloudData && JSON.stringify(cloudData) !== JSON.stringify(esimDatabase)) {
                            esimDatabase = cloudData;
                            filteredData = [...esimDatabase];
                            updateStats();
                            renderGrid();
                            renderTable();
                            console.log('Datos sincronizados autom√°ticamente');
                        }
                    } catch (error) {
                        console.error('Error en sincronizaci√≥n autom√°tica:', error);
                    }
                }
            }, CONFIG.syncInterval);
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('productFilter').addEventListener('change', applyFilters);
            document.getElementById('ipFilter').addEventListener('change', applyFilters);
            document.querySelector('.close').addEventListener('click', closeModal);
            document.getElementById('qrModal').addEventListener('click', function(e) {
                if (e.target === this) closeModal();
            });
        }

        // Funciones principales del sistema
        async function markAsUsed(id) {
            const esim = esimDatabase.find(item => item.id === id);
            if (!esim) return;

            // Actualizar localmente primero
            esim.estado = 'Usado';
            esim.fechaUltimoCambio = new Date().toISOString();

            // Actualizar interfaz inmediatamente
            updateStats();
            applyFilters();
            showNotification('eSIM marcada como usada', 'success');

            // Sincronizar con la nube
            if (isConnected) {
                try {
                    await cloudDB.update(esim.iccid, { estado: 'Usado' });
                    updateSyncStatus('Sincronizado', 'connected');
                } catch (error) {
                    console.error('Error sincronizando cambio:', error);
                    updateSyncStatus('Error de sincronizaci√≥n', 'error');
                }
            }

            // Respaldo local
            localStorage.setItem(CONFIG.localStorageKey, JSON.stringify(esimDatabase));
        }

        async function markAsAvailable(id) {
            const esim = esimDatabase.find(item => item.id === id);
            if (!esim) return;

            // Actualizar localmente primero
            esim.estado = 'Disponible';
            esim.fechaUltimoCambio = new Date().toISOString();

            // Actualizar interfaz inmediatamente
            updateStats();
            applyFilters();
            showNotification('eSIM marcada como disponible', 'success');

            // Sincronizar con la nube
            if (isConnected) {
                try {
                    await cloudDB.update(esim.iccid, { estado: 'Disponible' });
                    updateSyncStatus('Sincronizado', 'connected');
                } catch (error) {
                    console.error('Error sincronizando cambio:', error);
                    updateSyncStatus('Error de sincronizaci√≥n', 'error');
                }
            }

            // Respaldo local
            localStorage.setItem(CONFIG.localStorageKey, JSON.stringify(esimDatabase));
        }

        async function updateAssignment(id, assignedTo) {
            const esim = esimDatabase.find(item => item.id === id);
            if (!esim) return;

            // Actualizar localmente primero
            esim.asignadoA = assignedTo;
            esim.fechaUltimoCambio = new Date().toISOString();

            showNotification('Asignaci√≥n actualizada', 'success');

            // Sincronizar con la nube
            if (isConnected) {
                try {
                    await cloudDB.update(esim.iccid, { asignadoA: assignedTo });
                    updateSyncStatus('Sincronizado', 'connected');
                } catch (error) {
                    console.error('Error sincronizando asignaci√≥n:', error);
                    updateSyncStatus('Error de sincronizaci√≥n', 'error');
                }
            }

            // Respaldo local
            localStorage.setItem(CONFIG.localStorageKey, JSON.stringify(esimDatabase));
        }

        // Funciones de importaci√≥n de CSV
        function handleFileSelect(event) {
            selectedFile = event.target.files[0];
            const importBtn = document.getElementById('importBtn');
            
            if (selectedFile && selectedFile.type === 'text/csv') {
                importBtn.disabled = false;
                importBtn.textContent = `Importar ${selectedFile.name}`;
                showNotification('Archivo CSV seleccionado correctamente', 'success');
            } else {
                importBtn.disabled = true;
                importBtn.textContent = 'Importar eSIM';
                showNotification('Por favor selecciona un archivo CSV v√°lido', 'error');
            }
        }

        async function importCSV() {
            if (!selectedFile) {
                showNotification('No hay archivo seleccionado', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const csvContent = e.target.result;
                    const newEsimsCount = parseCSVData(csvContent);
                    
                    if (newEsimsCount > 0) {
                        filteredData = [...esimDatabase];
                        updateStats();
                        renderGrid();
                        renderTable();
                        showNotification(`${newEsimsCount} nuevas eSIM importadas correctamente`, 'success');
                        
                        // Sincronizar con la nube
                        if (isConnected) {
                            await cloudDB.save(esimDatabase);
                            updateSyncStatus('Datos sincronizados', 'connected');
                        }
                        
                        // Respaldo local
                        localStorage.setItem(CONFIG.localStorageKey, JSON.stringify(esimDatabase));
                    } else {
                        showNotification('No se encontraron nuevas eSIM en el archivo', 'info');
                    }
                    
                    // Limpiar selecci√≥n
                    document.getElementById('csvFileInput').value = '';
                    document.getElementById('importBtn').disabled = true;
                    document.getElementById('importBtn').textContent = 'Importar eSIM';
                    selectedFile = null;
                    
                } catch (error) {
                    console.error('Error importando CSV:', error);
                    showNotification('Error al procesar el archivo CSV', 'error');
                }
            };
            
            reader.readAsText(selectedFile);
        }

        // Funci√≥n de sincronizaci√≥n manual con GitHub
        async function syncWithGitHub() {
            if (!isConnected) {
                showNotification('Sin conexi√≥n a la nube', 'error');
                return;
            }

            try {
                updateSyncStatus('Sincronizando con GitHub...', 'connecting');
                
                // Obtener lista de archivos del repositorio
                const response = await fetch(CONFIG.githubApiUrl);
                if (!response.ok) throw new Error('Error al acceder a GitHub');
                
                const files = await response.json();
                const qrFiles = files.filter(file => 
                    file.name.endsWith('.png') && 
                    file.name.match(/^8952\d+\.png$/)
                );

                // Verificar si hay nuevas im√°genes QR
                let newQRsFound = 0;
                for (const file of qrFiles) {
                    const iccid = file.name.replace('.png', '');
                    const exists = esimDatabase.find(esim => esim.iccid === iccid);
                    
                    if (!exists) {
                        // Crear entrada para nueva eSIM encontrada en GitHub
                        esimDatabase.push({
                            id: esimDatabase.length + 1,
                            iccid: iccid,
                            asignadoA: "",
                            distribuidor: "BAITEL",
                            msisdn: "",
                            imsi: "",
                            pin: "1234",
                            puk: "",
                            serie: "",
                            ip: "CB127",
                            producto: "MOV",
                            estado: "Disponible",
                            fechaCreacion: new Date().toISOString().split('T')[0],
                            imageIndex: esimDatabase.length + 1,
                            fechaUltimoCambio: new Date().toISOString(),
                            fromGitHub: true
                        });
                        newQRsFound++;
                    }
                }

                if (newQRsFound > 0) {
                    await cloudDB.save(esimDatabase);
                    localStorage.setItem(CONFIG.localStorageKey, JSON.stringify(esimDatabase));
                    filteredData = [...esimDatabase];
                    updateStats();
                    renderGrid();
                    renderTable();
                    showNotification(`${newQRsFound} nuevas eSIM sincronizadas desde GitHub`, 'success');
                }

                updateSyncStatus('Sincronizado', 'connected');
            } catch (error) {
                console.error('Error sincronizando con GitHub:', error);
                updateSyncStatus('Error de sincronizaci√≥n', 'error');
                showNotification('Error al sincronizar con GitHub', 'error');
            }
        }

        function updateStats() {
            const total = esimDatabase.length;
            const available = esimDatabase.filter(item => item.estado === 'Disponible').length;
            const used = esimDatabase.filter(item => item.estado === 'Usado').length;
            document.getElementById('totalCount').textContent = total;
            document.getElementById('availableCount').textContent = available;
            document.getElementById('usedCount').textContent = used;
        }

        function renderGrid() {
            const gridView = document.getElementById('gridView');
            gridView.innerHTML = '';
            
            filteredData.forEach(esim => {
                const card = document.createElement('div');
                card.className = `esim-card ${esim.estado.toLowerCase()}`;
                const imageUrl = `${CONFIG.qrBaseUrl}${esim.iccid}.png`;
                
                card.innerHTML = `
                    <div class="status-badge ${esim.estado.toLowerCase()}">${esim.estado}</div>
                    <div class="qr-container">
                        <div class="qr-placeholder" onclick="showQRModal(${esim.id})">
                            <img src="${imageUrl}" 
                                 alt="QR ${esim.iccid}" 
                                 style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;"
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <div style="display: none; align-items: center; justify-content: center; height: 100%; color: #666; flex-direction: column;">
                                <div style="font-size: 24px; margin-bottom: 5px;">üì±</div>
                                <div style="font-size: 12px;">eSIM #${esim.imageIndex}</div>
                            </div>
                        </div>
                    </div>
                    <div class="esim-info">
                        <div class="field">
                            <span class="label">ICCID:</span>
                            <span class="value">${esim.iccid}</span>
                        </div>
                        <div class="field">
                            <span class="label">MSISDN:</span>
                            <span class="value">${esim.msisdn}</span>
                        </div>
                        <div class="field">
                            <span class="label">IMSI:</span>
                            <span class="value">${esim.imsi}</span>
                        </div>
                        <div class="field">
                            <span class="label">PIN:</span>
                            <span class="value">${esim.pin}</span>
                        </div>
                        <div class="field">
                            <span class="label">PUK:</span>
                            <span class="value">${esim.puk}</span>
                        </div>
                    </div>
                    <div class="assigned-to">
                        <label style="font-size: 12px; font-weight: 600; color: #495057; margin-bottom: 5px; display: block;">Asignado a:</label>
                        <input type="text" 
                               value="${esim.asignadoA}" 
                               placeholder="Nombre del usuario..."
                               onchange="updateAssignment(${esim.id}, this.value)"
                               style="width: 100%; padding: 6px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px;">
                    </div>
                    <div class="card-actions">
                        ${esim.estado === 'Disponible' ? 
                            `<button class="btn btn-warning" onclick="markAsUsed(${esim.id})">Marcar como Usado</button>` :
                            `<button class="btn btn-success" onclick="markAsAvailable(${esim.id})">Marcar como Disponible</button>`
                        }
                        <button class="btn btn-primary" onclick="copyEsimInfo(${esim.id})" style="font-size: 11px; padding: 6px 12px;">Copiar Info</button>
                    </div>
                `;
                gridView.appendChild(card);
            });
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';
            
            filteredData.forEach(esim => {
                const row = document.createElement('tr');
                const imageUrl = `${CONFIG.qrBaseUrl}${esim.iccid}.png`;
                
                row.innerHTML = `
                    <td>
                        <div class="qr-mini" onclick="showQRModal(${esim.id})" style="background-image: url('${imageUrl}'); background-size: cover; background-position: center;"></div>
                    </td>
                    <td style="font-family: monospace; font-size: 12px;">${esim.iccid}</td>
                    <td style="font-family: monospace;">${esim.msisdn}</td>
                    <td style="font-family: monospace; font-size: 12px;">${esim.imsi}</td>
                    <td>${esim.pin}</td>
                    <td style="font-family: monospace; font-size: 12px;">${esim.puk}</td>
                    <td><span class="status-badge ${esim.estado.toLowerCase()}">${esim.estado}</span></td>
                    <td>
                        <input type="text" 
                               value="${esim.asignadoA}" 
                               placeholder="Asignar a..."
                               onchange="updateAssignment(${esim.id}, this.value)"
                               style="width: 120px; padding: 4px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px;">
                    </td>
                    <td>
                        ${esim.estado === 'Disponible' ? 
                            `<button class="btn btn-warning" onclick="markAsUsed(${esim.id})">Usar</button>` :
                            `<button class="btn btn-success" onclick="markAsAvailable(${esim.id})">Liberar</button>`
                        }
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const productFilter = document.getElementById('productFilter').value;
            const ipFilter = document.getElementById('ipFilter').value;

            filteredData = esimDatabase.filter(esim => {
                const matchesSearch = !searchTerm || 
                    esim.iccid.toLowerCase().includes(searchTerm) ||
                    esim.msisdn.toLowerCase().includes(searchTerm) ||
                    esim.imsi.toLowerCase().includes(searchTerm) ||
                    esim.asignadoA.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || esim.estado === statusFilter;
                const matchesProduct = !productFilter || esim.producto === productFilter;
                const matchesIP = !ipFilter || esim.ip === ipFilter;

                return matchesSearch && matchesStatus && matchesProduct && matchesIP;
            });

            renderGrid();
            renderTable();
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('productFilter').value = '';
            document.getElementById('ipFilter').value = '';
            applyFilters();
        }

        function switchView(view) {
            const gridView = document.getElementById('gridView');
            const tableView = document.getElementById('tableView');
            const buttons = document.querySelectorAll('.view-toggle button');

            buttons.forEach(btn => btn.classList.remove('active'));

            if (view === 'grid') {
                gridView.style.display = 'grid';
                tableView.classList.remove('active');
                buttons[0].classList.add('active');
            } else {
                gridView.style.display = 'none';
                tableView.classList.add('active');
                buttons[1].classList.add('active');
            }
        }

        function showQRModal(id) {
            const esim = esimDatabase.find(item => item.id === id);
            if (!esim) return;

            document.getElementById('modalTitle').textContent = `eSIM #${esim.imageIndex} - ${esim.iccid}`;
            document.getElementById('modalQR').innerHTML = `
                <img src="${CONFIG.qrBaseUrl}${esim.iccid}.png" 
                     alt="QR ${esim.iccid}" 
                     style="width: 100%; height: 100%; object-fit: contain; border-radius: 4px;"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <div style="display: none; align-items: center; justify-content: center; height: 100%; color: #666; flex-direction: column;">
                    <div style="font-size: 48px; margin-bottom: 10px;">üì±</div>
                    <div>C√≥digo QR eSIM #${esim.imageIndex}</div>
                    <div style="font-size: 12px; margin-top: 10px; font-family: monospace;">${esim.iccid}</div>
                </div>
            `;
            
            document.getElementById('modalInfo').innerHTML = `
                <div style="text-align: left; margin-top: 20px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h4 style="margin-bottom: 15px; text-align: center;">Informaci√≥n Detallada</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-family: monospace; font-size: 14px;">
                        <div><strong>ICCID:</strong><br>${esim.iccid}</div>
                        <div><strong>MSISDN:</strong><br>${esim.msisdn}</div>
                        <div><strong>IMSI:</strong><br>${esim.imsi}</div>
                        <div><strong>Serie:</strong><br>${esim.serie}</div>
                        <div><strong>PIN:</strong><br>${esim.pin}</div>
                        <div><strong>PUK:</strong><br>${esim.puk}</div>
                        <div><strong>IP:</strong><br>${esim.ip}</div>
                        <div><strong>Producto:</strong><br>${esim.producto}</div>
                    </div>
                    <div class="assignment-input">
                        <label>Asignado a:</label>
                        <input type="text" 
                               id="modalAssignment" 
                               value="${esim.asignadoA}" 
                               placeholder="Nombre del usuario..."
                               onchange="updateAssignment(${esim.id}, this.value)">
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <span class="status-badge ${esim.estado.toLowerCase()}" style="font-size: 14px; padding: 8px 16px;">${esim.estado}</span>
                    </div>
                    <div style="text-align: center; margin-top: 15px; display: flex; gap: 10px; justify-content: center;">
                        ${esim.estado === 'Disponible' ? 
                            `<button class="btn btn-warning" onclick="markAsUsed(${esim.id}); closeModal();">Marcar como Usado</button>` :
                            `<button class="btn btn-success" onclick="markAsAvailable(${esim.id}); closeModal();">Marcar como Disponible</button>`
                        }
                        <button class="btn btn-primary" onclick="copyEsimInfo(${esim.id})">Copiar Informaci√≥n</button>
                    </div>
                </div>
            `;

            document.getElementById('qrModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('qrModal').style.display = 'none';
        }

        function copyEsimInfo(id) {
            const esim = esimDatabase.find(item => item.id === id);
            if (!esim) return;
            
            const info = `eSIM #${esim.imageIndex}
ICCID: ${esim.iccid}
MSISDN: ${esim.msisdn}
IMSI: ${esim.imsi}
PIN: ${esim.pin}
PUK: ${esim.puk}
Serie: ${esim.serie}
IP: ${esim.ip}
Producto: ${esim.producto}
Estado: ${esim.estado}
Asignado a: ${esim.asignadoA}
√öltima modificaci√≥n: ${esim.fechaUltimoCambio}`;

            navigator.clipboard.writeText(info).then(() => {
                showNotification('Informaci√≥n copiada al portapapeles', 'success');
            }).catch(() => {
                alert('Informaci√≥n de eSIM:\n\n' + info);
            });
        }

        // Funci√≥n de exportaci√≥n a Excel
        function exportToExcel() {
            try {
                // Preparar datos para exportaci√≥n
                const exportData = filteredData.map(esim => ({
                    'ICCID': esim.iccid,
                    'Asignado a': esim.asignadoA,
                    'MSISDN': esim.msisdn,
                    'IMSI': esim.imsi,
                    'PIN': esim.pin,
                    'PUK': esim.puk,
                    'Serie': esim.serie,
                    'IP': esim.ip,
                    'Producto': esim.producto,
                    'Estado': esim.estado,
                    'Fecha Creaci√≥n': esim.fechaCreacion,
                    '√öltima Modificaci√≥n': esim.fechaUltimoCambio
                }));

                // Crear libro de trabajo
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(exportData);

                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 25 }, // ICCID
                    { wch: 20 }, // Asignado a
                    { wch: 15 }, // MSISDN
                    { wch: 20 }, // IMSI
                    { wch: 8 },  // PIN
                    { wch: 12 }, // PUK
                    { wch: 10 }, // Serie
                    { wch: 8 },  // IP
                    { wch: 10 }, // Producto
                    { wch: 12 }, // Estado
                    { wch: 15 }, // Fecha Creaci√≥n
                    { wch: 20 }  // √öltima Modificaci√≥n
                ];
                ws['!cols'] = colWidths;

                // Agregar hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, 'eSIM BAITEL');

                // Generar nombre de archivo con fecha
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                const filename = `eSIM_BAITEL_${dateStr}_${timeStr}.xlsx`;

                // Descargar archivo
                XLSX.writeFile(wb, filename);
                
                showNotification(`Archivo exportado: ${filename}`, 'success');
            } catch (error) {
                console.error('Error exportando a Excel:', error);
                showNotification('Error al exportar archivo Excel', 'error');
            }
        }

        // Sistema de notificaciones
        function showNotification(message, type = 'info') {
            // Crear elemento de notificaci√≥n
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                transition: all 0.3s ease;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            `;

            // Colores seg√∫n tipo
            switch (type) {
                case 'success':
                    notification.style.background = '#27ae60';
                    break;
                case 'error':
                    notification.style.background = '#e74c3c';
                    break;
                default:
                    notification.style.background = '#3498db';
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>

